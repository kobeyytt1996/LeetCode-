# Cpp-Linux-Server-Frame
学习C++的过程中，尝试搭建一套linux上的高性能服务器框架，封装好各种基础模块，尽量使用了C++11的新特性。

## 一、功能介绍

​	目前该框架支持快速搭建Http Server，也可以用连接池进行Http请求。经过测试，性能和Nginx、libevent等框架相近。

### 	1. 基础功能：

​			a. 线程模块：封装了线程类和各种类型的锁和信号量。

​			b. 协程模块：封装协程类。定义了协程状态和在各种状态之间切换的接口。

​			c. 协程调度模块：提供线程池和多协程的调度，并具备定时器功能。并且针对IO有具体实现。

​			d. 配置系统：仅支持YAML的配置文件。支持基础类型、stl容器以及自定义数据类型的配置。

​			e. 日志系统：具备完善的日志系统功能，支持按照自定义格式输出日志。

### 	2. 网络功能：

​			a.  地址模块：封装了IPv4、IPv6等常用协议的地址类，并提供了域名转换、获取网卡IP等功能。

​			b. Socket模块：封装了Socket类，简化了socket的创建等使用。hook了socket相关的系统函数，实现以阻塞方式编程但底层为非阻塞的效果。

​			c. uri模块：根据RFC标准。封装Uri类，可以根据url解析出各部分。

​			d. 序列化模块：完成将常用数据类型序列化为二进制流和反序列化的方法。并提供压缩等功能。

### 	3. Http功能：

​			a. Http协议解析：使用ragel的有限状态机对Http请求和响应报文解析，效率极高。并增加分段解析和支持中文等。将解析结果封装为对应类。

​			b. Http服务器：可以监听多个端口，响应Http请求，并支持长连接。采用Servlet的封装来方便的增加业务处理逻辑。

​			c. Http请求池：提供给定url就能进行Http请求的功能。并提供连接池，可以重复使用连接并控制连接的生命周期。

## 二、性能表现

​	主要使用了多线程、多协程、有限状态机解析和连接池等方式提升性能。经多次压测，发现和Nginx、libevent等知名框架在处理Http请求上性能相当。

	1. 测试方式：使用httpd-tools的ab命令，测试100万次请求和500的并发，分别测试短连接和长连接。响应统一使用Nginx的400响应报文。
	1. 测试环境：虚拟机：CentOS 7.5 ; 编译器：GCC 9.1，优化级别为O3 ; CPU：4核8线程; 内存：16G ; Nginx版本：1.20.1
	1. 测试数据：

​	（以下测试数据为10次ab的qps均值，多线程是和Nginx多进程做比较的）

|          | 单线程（短连接） | 四线程（短连接） | 单线程（长连接） | 四线程（长连接） |
| -------- | ---------------- | ---------------- | ---------------- | ---------------- |
| 本框架   | 29543            | 35768            | 51953            | 115874           |
| Nginx    | 29260            |                  | 72787            |                  |
| libevent | 26992            | 未测试           | 60034            | 未测试           |

## 三、目录结构

  本项目使用cmake构建。yuan下为基础功能和Socket相关的模块的源码，yuan/http是针对HTTP封装的http服务器和请求连接池等的功能源码。tests下是每个基础功能完成时对应的测试用例，可以参考到具体如何使用封装好的类。examples下是一些使用示例，目前有一个echoServer。samples下是进行压测时的示例代码。
